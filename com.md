

本试验在macOS（m1）环境下执行
需要提前下载的内容：

1. 两个版本的zksolc
2. foundry-zksync-src
3. solc （solc-macosx-arm64-0.8.24-1.0.2）



0. 环境变量

```
ZKSOLC_OLD="/Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.2"
SOLC_ZK="/Users/dk/Desktop/code/zksync/solc-macosx-arm64-0.8.24-1.0.2"
ZKSOLC_NEW="/Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.3"

chmod +x /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.2  
xattr -l /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.2
xattr -d com.apple.quarantine /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.2

chmod +x /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.3  
xattr -l /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.3
xattr -d com.apple.quarantine /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.3
```

权限设置：

```
chmod +x /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.3  
xattr -l /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.3
xattr -d com.apple.quarantine /Users/dk/Desktop/code/zksync/zksolc-macosx-arm64-v1.5.3
```



1. 使用“错误版本编译器”（zksolc 1.5.2）编译代码

   准备 standard.json，使用standard.json作为输入进行编译

```json
{
  "language": "Solidity",
  "sources": {
    "MiscompileBitmap.sol": {
      "content": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.24;\n\ncontract MiscompileBitmap {\n    uint256 public data;\n\n    function setAllPairsUpTo(uint256 n) external {\n        uint256 x = 0;\n        for (uint256 i = 0; i <= n; i++) {\n            x |= (uint256(3) << (i << 1));\n        }\n        data = x;\n    }\n\n    function clearBorrow(uint256 reserveIndex) external {\n        uint256 bit = uint256(1) << (reserveIndex << 1);\n        data &= ~bit;\n    }\n}\n"
    }
  },
  "settings": {
    "optimizer": { "enabled": true, "runs": 200 },
    "outputSelection": {
      "*": {
        "*": ["abi", "evm", "eravm.assembly"]
      }
    }
  }
}
```

编译合约：

```
"$ZKSOLC_OLD" --solc "$SOLC_ZK" --standard-json < standard.json > out_old.json
"$ZKSOLC_NEW" --solc "$SOLC_ZK" --standard-json < standard.json > out_new.json
```



启动本地节点：

```
anvil-zksync -vv
```



继续设置一些环境变量：

```
RPC="http://localhost:8011"
PK="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
```

部署合约：

```
cast send --rpc-url http://localhost:8011 \
  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
  --zksync \
  --create 0x0000008003000039000000400030043f0000000100200190000000220000c13d000000000201001900000060022002700000001502200197000000040020008c000000400000413d000000000301043b000000e003300270000000170030009c000000390000613d000000180030009c0000002a0000613d000000190030009c000000400000c13d000000240020008c000000400000413d0000000002000416000000000002004b000000400000c13d0000000401100370000000000101043b00000001011002100000001d021002df000000010300008a000000ff0010008c000000000302a019000000000100041a000000000113016f000000000010041b0000000001000019000000500001042e0000000001000416000000000001004b000000400000c13d0000002001000039000001000010044300000120000004430000001601000041000000500001042e000000240020008c000000400000413d0000000002000416000000000002004b000000400000c13d0000000401100370000000000101043b0000001e0010009c000000420000c13d0000001b0100004100000000001004350000001101000039000000040010043f0000001c0100004100000051000104300000000001000416000000000001004b000000400000c13d000000000100041a000000800010043f0000001a01000041000000500001042e00000000010000190000005100010430000000000300001900000000020000190000000104300210000000030540020f000000ff0040008c0000000005002019000000000225019f000000000013004b0000000103300039000000440000413d000000000020041b0000000001000019000000500001042e0000004f00000432000000500001042e00000051000104300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000002000000000000000000000000000000400000010000000000000000000000000000000000000000000000000000000000000000000000000073d4a13a000000000000000000000000000000000000000000000000000000006430025500000000000000000000000000000000000000000000000000000000518b3ab200000000000000000000000000000000000000200000008000000000000000004e487b71000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000000000000000fffffffffffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000983b4808fcab980c1534eb50e8cff7f6d1c19f39caa899ad803a8952cec77507
  
blockHash            0x479c48525f08e451349aced669ff7ae6bd932cb14099a927b05e7948c865c904
blockNumber          1
contractAddress      0x588758d8a0Ad1162A6294f3C274753137E664aE0
  
  
cast send --rpc-url http://localhost:8011 \
  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
  --zksync \
  --create 0x0000008003000039000000400030043f0000000100200190000000220000c13d000000000201001900000060022002700000001502200197000000040020008c000000400000413d000000000301043b000000e003300270000000170030009c000000390000613d000000180030009c0000002a0000613d000000190030009c000000400000c13d000000240020008c000000400000413d0000000002000416000000000002004b000000400000c13d0000000401100370000000000101043b00000001011002100000001d021002df000000010300008a000000ff0010008c000000000302a019000000000100041a000000000113016f000000000010041b0000000001000019000000500001042e0000000001000416000000000001004b000000400000c13d0000002001000039000001000010044300000120000004430000001601000041000000500001042e000000240020008c000000400000413d0000000002000416000000000002004b000000400000c13d0000000401100370000000000101043b0000001e0010009c000000420000c13d0000001b01000041000000000010043f0000001101000039000000040010043f0000001c0100004100000051000104300000000001000416000000000001004b000000400000c13d000000000100041a000000800010043f0000001a01000041000000500001042e00000000010000190000005100010430000000000300001900000000020000190000000104300210000000030540020f000000ff0040008c0000000005002019000000000225019f000000000013004b0000000103300039000000440000413d000000000020041b0000000001000019000000500001042e0000004f00000432000000500001042e00000051000104300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000002000000000000000000000000000000400000010000000000000000000000000000000000000000000000000000000000000000000000000073d4a13a000000000000000000000000000000000000000000000000000000006430025500000000000000000000000000000000000000000000000000000000518b3ab200000000000000000000000000000000000000200000008000000000000000004e487b71000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000bf50b471dbb1d51e351cc35b3ecef964d8e707e34f7efa2a023f4829a445f4fa
  
  
blockHash            0xe63ce59ba89aa5839378352959e1a0b47df4b3cd1a1b18a5e7be00d38a750cd2
blockNumber          3
contractAddress      0x6B828bcb33305478cd7d27eB323F5C5B7b4aFdbe
```

继续设置一些环境变量：

```
ADDR_OLD="0x588758d8a0Ad1162A6294f3C274753137E664aE0"
ADDR_NEW="0x6B828bcb33305478cd7d27eB323F5C5B7b4aFdbe"
```





逐步进行函数调用：

```
调用问题合约：

cast send --rpc-url "$RPC" --private-key "$PK" --zksync \
  "$ADDR_OLD" "setAllPairsUpTo(uint256)" 120

cast call --rpc-url "$RPC" "$ADDR_OLD" "data()(uint256)"


cast send --rpc-url "$RPC" --private-key "$PK" --zksync \
  "$ADDR_OLD" "clearBorrow(uint256)" 80
  
cast call --rpc-url "$RPC" "$ADDR_OLD" "data()(uint256)"
 
 
调用新合约：

cast send --rpc-url "$RPC" --private-key "$PK" --zksync \
  "$ADDR_NEW" "setAllPairsUpTo(uint256)" 120

cast call --rpc-url "$RPC" "$ADDR_NEW" "data()(uint256)"


cast send --rpc-url "$RPC" --private-key "$PK" --zksync \
  "$ADDR_NEW" "clearBorrow(uint256)" 80
  
cast call --rpc-url "$RPC" "$ADDR_NEW" "data()(uint256)"
  
```



```
问题合约：
before：7067388259113537318333190002971674063309935587502475832486424805170479103
after： 26959946667150639791744011812357824837229774757108006441791745163264

正常合约：
before：7067388259113537318333190002971674063309935587502475832486424805170479103
after： 7067388259113537318333188541470036732407017383817643116203405149237936127
```

